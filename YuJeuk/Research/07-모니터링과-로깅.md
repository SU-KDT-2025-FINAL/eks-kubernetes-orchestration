# 모니터링과 로깅

## 📊 6.1 기본 모니터링 도구

### kubectl을 사용한 기본 모니터링

#### 리소스 사용량 확인
```bash
# 노드 리소스 사용량 확인
kubectl top nodes
# NAME                                               CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
# ip-192-168-1-234.ap-northeast-2.compute.internal   250m         12%    1024Mi          32%
# ip-192-168-2-123.ap-northeast-2.compute.internal   180m         9%     768Mi           24%

# Pod 리소스 사용량 확인
kubectl top pods
# NAME                                CPU(cores)   MEMORY(bytes)
# nginx-deployment-xxxxxxxxxx-xxxxx   1m           8Mi
# nginx-deployment-xxxxxxxxxx-yyyyy   1m           8Mi
# nginx-deployment-xxxxxxxxxx-zzzzz   1m           8Mi

# 특정 네임스페이스의 Pod 리소스 사용량
kubectl top pods -n kube-system
```

#### 클러스터 상태 모니터링
```bash
# 클러스터 전체 상태 확인
kubectl get componentstatuses
# NAME                 STATUS    MESSAGE             ERROR
# scheduler            Healthy   ok
# controller-manager   Healthy   ok
# etcd-0               Healthy   {"health":"true"}

# 노드 상태 확인
kubectl get nodes -o wide
# 각 노드의 상태, 버전, 내부/외부 IP 등 확인

# 시스템 Pod 상태 확인
kubectl get pods -n kube-system
```

### 실시간 모니터링
```bash
# Pod 상태 실시간 모니터링
kubectl get pods -w

# 특정 Deployment의 Pod 상태 모니터링
kubectl get pods -l app=nginx -w

# 이벤트 실시간 모니터링
kubectl get events -w
```

## 📝 6.2 로그 관리 및 분석

### 기본 로그 확인
```bash
# 특정 Pod 로그 확인
kubectl logs nginx-deployment-xxxxxxxxxx-xxxxx

# 실시간 로그 스트리밍
kubectl logs -f nginx-deployment-xxxxxxxxxx-xxxxx

# 최근 로그만 확인 (마지막 100줄)
kubectl logs --tail=100 nginx-deployment-xxxxxxxxxx-xxxxx

# 특정 시간 이후 로그 확인
kubectl logs --since=1h nginx-deployment-xxxxxxxxxx-xxxxx
```

### 여러 Pod 로그 동시 확인
```bash
# 라벨 기반으로 여러 Pod 로그 확인
kubectl logs -l app=nginx --tail=50

# Deployment의 모든 Pod 로그 확인
kubectl logs deployment/nginx-deployment

# 이전 컨테이너 로그 확인 (Pod가 재시작된 경우)
kubectl logs nginx-deployment-xxxxxxxxxx-xxxxx --previous
```

### 로그 필터링 및 분석
```bash
# 특정 키워드가 포함된 로그만 확인
kubectl logs -l app=nginx | grep "error"

# 여러 조건으로 필터링
kubectl logs -l app=nginx --since=30m | grep -E "(error|warning)" | tail -20

# JSON 형태 로그 파싱 (jq 사용)
kubectl logs deployment/api-server | jq '.level, .message'
```

## ☁️ 6.3 AWS CloudWatch 통합

### EKS 클러스터 로깅 활성화
```bash
# eksctl을 사용한 로깅 활성화
eksctl utils update-cluster-logging --enable-types=all --region=ap-northeast-2 --cluster=my-first-cluster

# 특정 로그 타입만 활성화
eksctl utils update-cluster-logging --enable-types=api,audit,authenticator --region=ap-northeast-2 --cluster=my-first-cluster

# 로깅 비활성화
eksctl utils update-cluster-logging --disable-types=all --region=ap-northeast-2 --cluster=my-first-cluster
```

### CloudWatch 로그 그룹 확인
```bash
# AWS CLI로 로그 그룹 확인
aws logs describe-log-groups --log-group-name-prefix="/aws/eks/my-first-cluster"

# 로그 스트림 확인
aws logs describe-log-streams --log-group-name="/aws/eks/my-first-cluster/cluster"
```

### Container Insights 설정
```bash
# CloudWatch Container Insights 설치
curl https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/quickstart/cwagent-fluentd-quickstart.yaml | sed "s/{{cluster_name}}/my-first-cluster/;s/{{region_name}}/ap-northeast-2/" | kubectl apply -f -

# 설치 확인
kubectl get pods -n amazon-cloudwatch
```

### CloudWatch Insights 쿼리 예시
```sql
-- Pod별 CPU 사용률 확인
fields @timestamp, kubernetes.pod_name, kubernetes.container_name, CpuUtilized
| filter kubernetes.namespace_name = "default"
| sort @timestamp desc
| limit 100

-- 에러 로그 검색
fields @timestamp, log
| filter log like /error/
| sort @timestamp desc
| limit 50

-- 특정 애플리케이션의 응답 시간 분석
fields @timestamp, kubernetes.pod_name, log
| filter kubernetes.labels.app = "nginx"
| filter log like /response_time/
| sort @timestamp desc
```

## 📈 6.4 Prometheus와 Grafana 설정 (고급)

### Prometheus 설치
```bash
# Helm을 사용한 Prometheus 설치
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# Prometheus 설치
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --create-namespace \
  --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
  --set prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues=false

# 설치 확인
kubectl get pods -n monitoring
```

### Grafana 접근 설정
```bash
# Grafana 서비스를 LoadBalancer로 변경
kubectl patch service prometheus-grafana -n monitoring -p '{"spec":{"type":"LoadBalancer"}}'

# Grafana 관리자 비밀번호 확인
kubectl get secret prometheus-grafana -n monitoring -o jsonpath="{.data.admin-password}" | base64 --decode

# Grafana 접근 URL 확인
kubectl get service prometheus-grafana -n monitoring
```

### 커스텀 메트릭 수집 설정
```yaml
# custom-metrics.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-metrics-config
  namespace: monitoring
data:
  custom-metrics.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
    - job_name: 'my-app'
      static_configs:
      - targets: ['my-app-service:8080']
      metrics_path: /metrics
      scrape_interval: 10s
```

## 🚨 6.5 알림 및 경고 설정

### 기본 알림 규칙 설정
```yaml
# alert-rules.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: my-app-alerts
  namespace: monitoring
spec:
  groups:
  - name: my-app.rules
    rules:
    - alert: PodCrashLooping
      expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.pod }} is crash looping"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting frequently"
    
    - alert: HighCPUUsage
      expr: (sum by (pod) (rate(container_cpu_usage_seconds_total[5m]))) > 0.8
      for: 10m
      labels:
        severity: critical
      annotations:
        summary: "High CPU usage detected"
        description: "Pod {{ $labels.pod }} CPU usage is above 80%"
```

### Slack 알림 설정
```yaml
# alertmanager-config.yaml
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-prometheus-kube-prometheus-alertmanager
  namespace: monitoring
type: Opaque
stringData:
  alertmanager.yml: |
    global:
      slack_api_url: 'YOUR_SLACK_WEBHOOK_URL'
    
    route:
      group_by: ['alertname']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'slack-notifications'
    
    receivers:
    - name: 'slack-notifications'
      slack_configs:
      - channel: '#alerts'
        title: 'Kubernetes Alert'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
```

## 🔍 6.6 애플리케이션 성능 모니터링

### 애플리케이션 메트릭 노출
```yaml
# metrics-enabled-app.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: metrics-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: metrics-app
  template:
    metadata:
      labels:
        app: metrics-app
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: app
        image: prom/node-exporter:latest
        ports:
        - containerPort: 9100
          name: metrics
```

### 커스텀 대시보드 생성
```json
{
  "dashboard": {
    "title": "My Application Dashboard",
    "panels": [
      {
        "title": "Pod CPU Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "sum by (pod) (rate(container_cpu_usage_seconds_total{namespace=\"default\"}[5m]))",
            "legendFormat": "{{ pod }}"
          }
        ]
      },
      {
        "title": "Pod Memory Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "sum by (pod) (container_memory_usage_bytes{namespace=\"default\"})",
            "legendFormat": "{{ pod }}"
          }
        ]
      }
    ]
  }
}
```

## 🛠️ 6.7 실용적인 모니터링 스크립트

### 자동 상태 체크 스크립트
```bash
#!/bin/bash
# health-check.sh

echo "=== Cluster Health Check ==="
echo "Date: $(date)"
echo

echo "1. Node Status:"
kubectl get nodes --no-headers | while read node status roles age version; do
    if [ "$status" != "Ready" ]; then
        echo "⚠️  Node $node is $status"
    else
        echo "✅ Node $node is Ready"
    fi
done

echo
echo "2. Pod Status:"
kubectl get pods --all-namespaces --no-headers | while read namespace name ready status restarts age; do
    if [[ "$status" != "Running" && "$status" != "Completed" ]]; then
        echo "⚠️  Pod $namespace/$name is $status"
    fi
done

echo
echo "3. Resource Usage:"
kubectl top nodes 2>/dev/null || echo "Metrics server not available"

echo
echo "4. Recent Events:"
kubectl get events --sort-by=.metadata.creationTimestamp | tail -5
```

### 로그 분석 스크립트
```bash
#!/bin/bash
# log-analyzer.sh

APP_NAME=${1:-nginx}
NAMESPACE=${2:-default}
TIME_RANGE=${3:-1h}

echo "=== Log Analysis for $APP_NAME ==="
echo "Namespace: $NAMESPACE"
echo "Time Range: $TIME_RANGE"
echo

# 에러 로그 카운트
echo "Error Count:"
kubectl logs -l app=$APP_NAME -n $NAMESPACE --since=$TIME_RANGE | grep -i error | wc -l

echo
echo "Warning Count:"
kubectl logs -l app=$APP_NAME -n $NAMESPACE --since=$TIME_RANGE | grep -i warning | wc -l

echo
echo "Recent Errors:"
kubectl logs -l app=$APP_NAME -n $NAMESPACE --since=$TIME_RANGE | grep -i error | tail -5

echo
echo "Top Error Messages:"
kubectl logs -l app=$APP_NAME -n $NAMESPACE --since=$TIME_RANGE | grep -i error | sort | uniq -c | sort -nr | head -5
```

## 🎯 6단계 완료 체크리스트

### 기본 모니터링
- [ ] kubectl을 사용한 리소스 사용량 확인 가능
- [ ] Pod 및 노드 상태 모니터링 가능
- [ ] 실시간 로그 스트리밍 확인 가능
- [ ] 여러 Pod 로그 동시 확인 가능

### AWS CloudWatch 통합
- [ ] EKS 클러스터 로깅 활성화 완료
- [ ] CloudWatch 로그 그룹에서 로그 확인 가능
- [ ] Container Insights 설치 및 확인 (선택사항)
- [ ] CloudWatch Insights 쿼리 실행 가능

### 고급 모니터링 (선택사항)
- [ ] Prometheus 설치 및 설정 완료
- [ ] Grafana 대시보드 접근 가능
- [ ] 기본 알림 규칙 설정 완료
- [ ] 커스텀 메트릭 수집 설정

### 실용적 도구
- [ ] 상태 체크 스크립트 작성 및 실행
- [ ] 로그 분석 스크립트 작성 및 실행
- [ ] 문제 상황 발생 시 대응 방법 숙지

## 💡 모니터링 베스트 프랙티스

### 1. 계층별 모니터링
```
인프라 레벨: 노드 CPU, 메모리, 디스크, 네트워크
플랫폼 레벨: Pod 상태, 서비스 가용성, 리소스 할당
애플리케이션 레벨: 응답 시간, 에러율, 비즈니스 메트릭
```

### 2. 알림 설정 원칙
- **중요도별 분류**: Critical, Warning, Info
- **알림 피로도 방지**: 너무 많은 알림은 오히려 역효과
- **실행 가능한 알림**: 받은 알림에 대해 명확한 대응 방안 필요

### 3. 로그 관리 전략
- **구조화된 로그**: JSON 형태로 로그 출력
- **적절한 로그 레벨**: DEBUG, INFO, WARN, ERROR 구분
- **로그 보존 정책**: 비용과 규정 준수 고려

## 🤔 자주 묻는 질문

**Q: kubectl top 명령어가 작동하지 않아요.**
A: Metrics Server가 설치되어 있지 않을 수 있습니다. `kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml`로 설치하세요.

**Q: CloudWatch 로그가 너무 많아서 비용이 걱정됩니다.**
A: 로그 보존 기간을 조정하고, 필요한 로그 타입만 활성화하세요. 또한 로그 필터링을 통해 중요한 로그만 수집할 수 있습니다.

**Q: Prometheus와 CloudWatch 중 어떤 것을 사용해야 하나요?**
A: AWS 환경에서는 CloudWatch가 통합성 면에서 유리하고, 멀티 클라우드나 온프레미스 환경에서는 Prometheus가 더 적합합니다.

---

**다음 단계**: [08-고급-기능-실습.md](./08-고급-기능-실습.md)로 이동하여 ConfigMap, Secret, PV 등 고급 기능을 학습하세요.