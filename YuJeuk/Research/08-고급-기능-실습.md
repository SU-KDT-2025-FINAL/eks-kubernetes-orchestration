# ê³ ê¸‰ ê¸°ëŠ¥ ì‹¤ìŠµ

## ğŸ”§ 7.1 ConfigMapê³¼ Secret

### ConfigMap - ì„¤ì • ì •ë³´ ë¶„ë¦¬

#### ConfigMap ìƒì„± ë°©ë²•ë“¤
```bash
# 1. ëª…ë ¹ì–´ë¡œ ì§ì ‘ ìƒì„±
kubectl create configmap app-config \
  --from-literal=database_url=mysql://localhost:3306/mydb \
  --from-literal=debug_mode=true \
  --from-literal=max_connections=100

# 2. íŒŒì¼ì—ì„œ ìƒì„±
echo "database_url=mysql://localhost:3306/mydb" > app.properties
echo "debug_mode=true" >> app.properties
kubectl create configmap app-config --from-file=app.properties

# 3. YAML íŒŒì¼ë¡œ ìƒì„±
```

```yaml
# app-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  database_url: "mysql://localhost:3306/mydb"
  debug_mode: "true"
  max_connections: "100"
  app.properties: |
    database_url=mysql://localhost:3306/mydb
    debug_mode=true
    max_connections=100
    log_level=info
```

#### ConfigMap ì‚¬ìš©í•˜ê¸°
```yaml
# configmap-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: configmap-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: configmap-app
  template:
    metadata:
      labels:
        app: configmap-app
    spec:
      containers:
      - name: app
        image: nginx:1.20
        # í™˜ê²½ ë³€ìˆ˜ë¡œ ì‚¬ìš©
        env:
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: database_url
        - name: DEBUG_MODE
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: debug_mode
        # ëª¨ë“  í‚¤ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ê°€ì ¸ì˜¤ê¸°
        envFrom:
        - configMapRef:
            name: app-config
        # ë³¼ë¥¨ìœ¼ë¡œ ë§ˆìš´íŠ¸
        volumeMounts:
        - name: config-volume
          mountPath: /etc/config
      volumes:
      - name: config-volume
        configMap:
          name: app-config
```

### Secret - ë¯¼ê°í•œ ì •ë³´ ì•ˆì „í•˜ê²Œ ê´€ë¦¬

#### Secret ìƒì„±
```bash
# 1. ëª…ë ¹ì–´ë¡œ ì§ì ‘ ìƒì„±
kubectl create secret generic db-secret \
  --from-literal=username=admin \
  --from-literal=password=secretpassword123

# 2. íŒŒì¼ì—ì„œ ìƒì„±
echo -n 'admin' > username.txt
echo -n 'secretpassword123' > password.txt
kubectl create secret generic db-secret \
  --from-file=username=username.txt \
  --from-file=password=password.txt

# 3. YAML íŒŒì¼ë¡œ ìƒì„± (base64 ì¸ì½”ë”© í•„ìš”)
echo -n 'admin' | base64  # YWRtaW4=
echo -n 'secretpassword123' | base64  # c2VjcmV0cGFzc3dvcmQxMjM=
```

```yaml
# db-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
data:
  username: YWRtaW4=  # admin (base64 encoded)
  password: c2VjcmV0cGFzc3dvcmQxMjM=  # secretpassword123 (base64 encoded)
```

#### Secret ì‚¬ìš©í•˜ê¸°
```yaml
# secret-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: secret-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: secret-app
  template:
    metadata:
      labels:
        app: secret-app
    spec:
      containers:
      - name: app
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: password
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: username
        # ë³¼ë¥¨ìœ¼ë¡œ ë§ˆìš´íŠ¸ (íŒŒì¼ë¡œ ì ‘ê·¼)
        volumeMounts:
        - name: secret-volume
          mountPath: /etc/secrets
          readOnly: true
      volumes:
      - name: secret-volume
        secret:
          secretName: db-secret
```

## ğŸ’¾ 7.2 Persistent Volume (ì˜êµ¬ ìŠ¤í† ë¦¬ì§€)

### EBS ë³¼ë¥¨ì„ ì‚¬ìš©í•œ Persistent Volume

#### StorageClass í™•ì¸
```bash
# ê¸°ë³¸ StorageClass í™•ì¸
kubectl get storageclass
# NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
# gp2 (default)   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  1h
```

#### PersistentVolumeClaim ìƒì„±
```yaml
# mysql-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: gp2
```

#### PVCë¥¼ ì‚¬ìš©í•˜ëŠ” MySQL ë°°í¬
```yaml
# mysql-with-pv.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-persistent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql-persistent
  template:
    metadata:
      labels:
        app: mysql-persistent
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: password
        - name: MYSQL_DATABASE
          value: "testdb"
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
spec:
  selector:
    app: mysql-persistent
  ports:
  - port: 3306
    targetPort: 3306
  type: ClusterIP
```

#### ë°ì´í„° ì˜ì†ì„± í…ŒìŠ¤íŠ¸
```bash
# MySQL Podì— ì ‘ì†í•˜ì—¬ ë°ì´í„° ìƒì„±
kubectl exec -it deployment/mysql-persistent -- mysql -u root -p

# MySQL ë‚´ì—ì„œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
CREATE DATABASE testdb;
USE testdb;
CREATE TABLE users (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(50));
INSERT INTO users (name) VALUES ('Alice'), ('Bob'), ('Charlie');
SELECT * FROM users;
exit

# Pod ì‚­ì œ í›„ ì¬ìƒì„±
kubectl delete pod -l app=mysql-persistent

# ìƒˆë¡œìš´ Podì—ì„œ ë°ì´í„° í™•ì¸
kubectl exec -it deployment/mysql-persistent -- mysql -u root -p -e "USE testdb; SELECT * FROM users;"
```

## ğŸ“ˆ 7.3 Horizontal Pod Autoscaler (HPA)

### Metrics Server ì„¤ì¹˜ (í•„ìš” ì‹œ)
```bash
# Metrics Server ì„¤ì¹˜
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

# ì„¤ì¹˜ í™•ì¸
kubectl get pods -n kube-system | grep metrics-server
```

### CPU ê¸°ë°˜ HPA ì„¤ì •
```yaml
# cpu-intensive-app.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cpu-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cpu-app
  template:
    metadata:
      labels:
        app: cpu-app
    spec:
      containers:
      - name: cpu-app
        image: k8s.gcr.io/hpa-example
        ports:
        - containerPort: 80
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
---
apiVersion: v1
kind: Service
metadata:
  name: cpu-app-service
spec:
  selector:
    app: cpu-app
  ports:
  - port: 80
    targetPort: 80
  type: LoadBalancer
```

#### HPA ìƒì„±
```bash
# ëª…ë ¹ì–´ë¡œ HPA ìƒì„±
kubectl autoscale deployment cpu-app --cpu-percent=50 --min=1 --max=10

# ë˜ëŠ” YAML íŒŒì¼ë¡œ ìƒì„±
```

```yaml
# hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: cpu-app-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cpu-app
  minReplicas: 1
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 70
```

#### HPA í…ŒìŠ¤íŠ¸
```bash
# HPA ìƒíƒœ í™•ì¸
kubectl get hpa
# NAME          REFERENCE            TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
# cpu-app-hpa   Deployment/cpu-app   0%/50%    1         10        1          2m

# ë¶€í•˜ ìƒì„± (ë³„ë„ í„°ë¯¸ë„ì—ì„œ)
kubectl run -i --tty load-generator --rm --image=busybox --restart=Never -- /bin/sh
# Pod ë‚´ì—ì„œ ì‹¤í–‰:
while true; do wget -q -O- http://cpu-app-service; done

# HPA ë™ì‘ í™•ì¸ (ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§)
kubectl get hpa -w
kubectl get pods -w
```

### ì»¤ìŠ¤í…€ ë©”íŠ¸ë¦­ ê¸°ë°˜ HPA (ê³ ê¸‰)
```yaml
# custom-metrics-hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: custom-metrics-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: my-app
  minReplicas: 2
  maxReplicas: 20
  metrics:
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: "100"
  - type: External
    external:
      metric:
        name: sqs_queue_length
        selector:
          matchLabels:
            queue: "my-queue"
      target:
        type: Value
        value: "10"
```

## ğŸŒ 7.4 Ingress Controller

### AWS Load Balancer Controller ì„¤ì¹˜
```bash
# IAM ì •ì±… ìƒì„±
curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.4/docs/install/iam_policy.json

aws iam create-policy \
    --policy-name AWSLoadBalancerControllerIAMPolicy \
    --policy-document file://iam_policy.json

# ServiceAccount ìƒì„±
eksctl create iamserviceaccount \
  --cluster=my-first-cluster \
  --namespace=kube-system \
  --name=aws-load-balancer-controller \
  --role-name "AmazonEKSLoadBalancerControllerRole" \
  --attach-policy-arn=arn:aws:iam::ACCOUNT-ID:policy/AWSLoadBalancerControllerIAMPolicy \
  --approve

# Helmìœ¼ë¡œ AWS Load Balancer Controller ì„¤ì¹˜
helm repo add eks https://aws.github.io/eks-charts
helm repo update

helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \
  --set clusterName=my-first-cluster \
  --set serviceAccount.create=false \
  --set serviceAccount.name=aws-load-balancer-controller
```

### ê¸°ë³¸ Ingress ì„¤ì •
```yaml
# basic-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: basic-ingress
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
spec:
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              number: 80
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 80
```

### ë„ë©”ì¸ ê¸°ë°˜ ë¼ìš°íŒ…
```yaml
# domain-based-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: domain-ingress
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:region:account:certificate/cert-id
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
spec:
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 80
  - host: web.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web-service
            port:
              number: 80
```

## ğŸ”’ 7.5 ë„¤íŠ¸ì›Œí¬ ì •ì±… (Network Policy)

### Calico ì„¤ì¹˜ (ë„¤íŠ¸ì›Œí¬ ì •ì±… ì§€ì›)
```bash
# Calico ì„¤ì¹˜
kubectl apply -f https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/master/config/master/calico-operator.yaml
kubectl apply -f https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/master/config/master/calico-crs.yaml
```

### ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ì •ì±…
```yaml
# network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
  namespace: default
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-nginx
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: nginx
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 80
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-database
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: mysql
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 3306
```

## ğŸ¯ 7ë‹¨ê³„ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ConfigMapê³¼ Secret
- [ ] ConfigMap ìƒì„± ë° í™˜ê²½ ë³€ìˆ˜ë¡œ ì‚¬ìš© ì„±ê³µ
- [ ] ConfigMapì„ ë³¼ë¥¨ìœ¼ë¡œ ë§ˆìš´íŠ¸í•˜ì—¬ íŒŒì¼ë¡œ ì‚¬ìš© ì„±ê³µ
- [ ] Secret ìƒì„± ë° ë¯¼ê°í•œ ì •ë³´ ê´€ë¦¬ ì„±ê³µ
- [ ] Secretì„ í™˜ê²½ ë³€ìˆ˜ì™€ ë³¼ë¥¨ìœ¼ë¡œ ì‚¬ìš© ì„±ê³µ

### Persistent Volume
- [ ] PVC ìƒì„± ë° Podì— ì—°ê²° ì„±ê³µ
- [ ] ë°ì´í„° ì˜ì†ì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ (Pod ì¬ì‹œì‘ í›„ ë°ì´í„° ìœ ì§€ í™•ì¸)
- [ ] EBS ë³¼ë¥¨ì´ AWS ì½˜ì†”ì—ì„œ í™•ì¸ë¨

### Horizontal Pod Autoscaler
- [ ] Metrics Server ì„¤ì¹˜ ë° ë™ì‘ í™•ì¸
- [ ] CPU ê¸°ë°˜ HPA ì„¤ì • ë° í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] ë¶€í•˜ ì¦ê°€ ì‹œ Pod ìë™ í™•ì¥ í™•ì¸
- [ ] ë¶€í•˜ ê°ì†Œ ì‹œ Pod ìë™ ì¶•ì†Œ í™•ì¸

### Ingress Controller
- [ ] AWS Load Balancer Controller ì„¤ì¹˜ ì„±ê³µ
- [ ] ê¸°ë³¸ Ingress ì„¤ì • ë° ALB ìƒì„± í™•ì¸
- [ ] ê²½ë¡œ ê¸°ë°˜ ë¼ìš°íŒ… ë™ì‘ í™•ì¸
- [ ] ë„ë©”ì¸ ê¸°ë°˜ ë¼ìš°íŒ… ì„¤ì • (ì„ íƒì‚¬í•­)

### ë„¤íŠ¸ì›Œí¬ ì •ì±… (ì„ íƒì‚¬í•­)
- [ ] ë„¤íŠ¸ì›Œí¬ ì •ì±… ì„¤ì • ë° íŠ¸ë˜í”½ ì œì–´ í™•ì¸

## ğŸ’¡ ì‹¤ìŠµ íŒ

### ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
```bash
# ëª¨ë“  ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ë¥¼ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ë¶„ë¦¬
kubectl create namespace advanced-features
kubectl apply -f . -n advanced-features

# ì‹¤ìŠµ ì™„ë£Œ í›„ ì •ë¦¬
kubectl delete namespace advanced-features
```

### ë¬¸ì œ í•´ê²°
```bash
# PVCê°€ Pending ìƒíƒœì¸ ê²½ìš°
kubectl describe pvc mysql-pvc
# Events ì„¹ì…˜ì—ì„œ ì›ì¸ í™•ì¸

# HPAê°€ ë™ì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš°
kubectl describe hpa cpu-app-hpa
# Metrics Server ìƒíƒœ í™•ì¸
kubectl get pods -n kube-system | grep metrics-server

# Ingressê°€ ALBë¥¼ ìƒì„±í•˜ì§€ ì•ŠëŠ” ê²½ìš°
kubectl describe ingress basic-ingress
# AWS Load Balancer Controller ë¡œê·¸ í™•ì¸
kubectl logs -n kube-system deployment/aws-load-balancer-controller
```

## ğŸ¤” ìì£¼ ë¬»ëŠ” ì§ˆë¬¸

**Q: ConfigMapê³¼ Secretì˜ ì°¨ì´ì ì€ ë¬´ì—‡ì¸ê°€ìš”?**
A: ConfigMapì€ ì¼ë°˜ ì„¤ì • ì •ë³´ë¥¼, Secretì€ ë¹„ë°€ë²ˆí˜¸ ê°™ì€ ë¯¼ê°í•œ ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. Secretì€ base64ë¡œ ì¸ì½”ë”©ë˜ê³  ë” ì—„ê²©í•œ ì ‘ê·¼ ì œì–´ê°€ ì ìš©ë©ë‹ˆë‹¤.

**Q: PVCë¥¼ ì‚­ì œí•˜ë©´ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë˜ë‚˜ìš”?**
A: StorageClassì˜ reclaimPolicyì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤. ê¸°ë³¸ê°’ì¸ 'Delete'ëŠ” PVC ì‚­ì œ ì‹œ ë³¼ë¥¨ë„ ì‚­ì œí•˜ê³ , 'Retain'ì€ ë³¼ë¥¨ì„ ë³´ì¡´í•©ë‹ˆë‹¤.

**Q: HPAê°€ ë„ˆë¬´ ìì£¼ ìŠ¤ì¼€ì¼ë§í•´ì„œ ë¶ˆì•ˆì •í•´ìš”.**
A: `--horizontal-pod-autoscaler-downscale-stabilization` ì˜µì…˜ìœ¼ë¡œ ì¶•ì†Œ ì•ˆì •í™” ì‹œê°„ì„ ì¡°ì •í•˜ê±°ë‚˜, behavior ì„¤ì •ì„ í†µí•´ ìŠ¤ì¼€ì¼ë§ ì†ë„ë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

**ë‹¤ìŒ ë‹¨ê³„**: [09-ì‹¤ì „-í”„ë¡œì íŠ¸.md](./09-ì‹¤ì „-í”„ë¡œì íŠ¸.md)ë¡œ ì´ë™í•˜ì—¬ ì¢…í•©ì ì¸ ì‹¤ì „ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ì„¸ìš”.